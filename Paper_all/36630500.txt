https://doi.org/10.1126/sciadv.adc9130
Machine learning enables prediction of metabolic system evolution in bacteria
Abstract Evolution prediction is a long-standing goal in evolutionary biology, with potential impacts on strategic pathogen control, genome engineering, and synthetic biology. While laboratory evolution studies have shown the predictability of short-term and sequence-level evolution, that of long-term and system-level evolution has not been systematically examined. Here, we show that the gene content evolution of metabolic systems is generally predictable by applying ancestral gene content reconstruction and machine learning techniques to ~3000 bacterial genomes. Our framework, Evodictor, successfully predicted gene gain and loss evolution at the branches of the reference phylogenetic tree, suggesting that evolutionary pressures and constraints on metabolic systems are universally shared. Investigation of pathway architectures and meta-analysis of metagenomic datasets confirmed that these evolutionary patterns have physiological and ecological bases as functional dependencies among metabolic reactions and bacterial habitat changes. Last, pan-genomic analysis of intraspecies gene content variations proved that even “ongoing” evolution in extant bacterial species is predictable in our framework.
INTRODUCTION Uncovering rules and predicting the future of life are foundational objectives in evolutionary biology and many related fields. Naturally, genomic changes, such as substitutions, insertions/deletions, and horizontal gene transfers (HGTs), occur stochastically. While these changes can randomly dominate populations by genetic drift (1), evolutionary pressures can also preferentially select specific changes constrained or biased by developmental (2), physiological (3), ecological (4), and phylogenetic effects (5). If these evolutionary pressures and constraints are universal and shared across different lineages, then similar evolutionary patterns will be repetitively observed and can be used to predict future evolution. It was also envisioned that uncovering these patterns and predicting evolution would empower us to design effective strategies in bioengineering and synthetic biology (6).
The predictability of evolution has been extensively studied for short-term and sequence-level evolution, that is, at the microevolution scale. Laboratory evolution of Escherichia coli and Saccharomyces cerevisiae traced by DNA sequencing and targeted genetic modification has shown that many sequence-level mutations can independently and repetitively accumulate (7, 8) and are contingent upon previous genetic changes (9–11). These evolutionary patterns reflect the fitness landscapes shaped by epistatic interactions, thus enabling the prediction and control of short-term evolution (9, 12, 13). Predictive modeling of antibiotic resistance evolution has been applied in selecting drugs to suppress the emergence of resistance in pathogens (14, 15). In addition, cancer cell evolution has predictable, sequential patterns of mutations, which will help the diagnosis of cancer stages and the selection of effective treatments (16). Furthermore, a recent study showed the predictability of viral sequence mutations to evade the immune system, providing insights into the design of antibody drugs that avoid tolerance evolution (17).
On the other hand, few studies have investigated the predictability of more marked, long-term, and system-level evolution at the macroevolutionary scale, such as metabolic system evolution by tens to hundreds of gene gains and losses. While limited exceptions include findings of specific HGT order patterns, such as those in the Rubisco subunit genes (18) and prediction of losable genes on streamlining genomes (19), it is still impossible to know which species will likely gain and lose a given gene in the future. Such a lack of studies is principally because system-level evolution is seldom directly not observable in laboratories. However, abundant genome data, large-scale phylogenetic trees, ancestral gene content reconstruction methods, and machine learning techniques are now becoming available to systematically reconstruct the gene content (i.e., gene sets on genomes) of ancestral species, enumerate gene gain/loss events across diverse phylogenetic clades, and reveal universal patterns of gene gain/loss events (20–23). Despite growing datasets and technologies, no study has comprehensively examined the predictability of biological system evolution.
This study developed a versatile analysis framework that enables us to learn the patterns and rules of gene content evolution using machine learning approaches. Analysis of the reconstructed gene content evolution based on 2894 extant bacterial genomes in diverse phyla demonstrated that the gene gain/loss events of various metabolic genes were substantially predictable. These evolutionary patterns are confirmed to have solid physiological and ecological bases and can be used to predict ongoing evolution using pan-genomic datasets. We envision that our approach will enable forecasting of the future evolution of genomes and provide insights into the design principles of biological systems.
RESULTS Gene content evolution is predicted by ancestral reconstruction and machine learning We systematically evaluated the predictability of gene content evolution and established a machine learning approach, Evodictor, which predicts long-term and system-level evolution. We initially inferred the gene content of the ancestral species using the genomes of 2894 bacterial species (encompassing 50 phyla) and a reference phylogeny (Fig. 1, A and B). Specifically, for every ortholog group (OG) in metabolic pathways in the Kyoto Encyclopedia of Genes and Genomes (KEGG) (24), we reconstructed the presence (represented as one) or absence (zero) of genes belonging to that OG at every internal node of the reference phylogenetic tree or ancestral species’ gene content vectors whose size was equal to the total OG number (Fig. 1C). Reconstruction was conducted by maximizing and approximating the posterior probabilities under a Markov model using a previously established method (21). Because ancestral reconstruction contains uncertainty, we evaluated the confidence of every estimate by the posterior probability of each state. By following a previous study (21), 1.82% of the estimated states remained undetermined and was labeled as 0.5 in the following analyses (fig. S1A). Then, we enumerated the branches where gene gains (zero-to-one transitions) or losses (one-to-zero transitions) occurred for each OG. The gene losses were significantly larger than those of gene gains, which is consistent with previous reports (two-sided paired t test, P = 5.32 × 10−263) (fig. S1B) (18).
We then developed methods for predicting what genes will be gained or lost in metabolic pathway evolution. Specifically, we used two machine learning models, logistic regression (LR) and random forest (RF), to predict the probability of gene gain (if an OG is absent at the parental node) and loss (if present) for every OG using the gene content vector of the parental node in the phylogenetic tree (Fig. 1D). To measure predictability, we conducted cross-validation tests by enumerating pairs of parental gene content vectors and occurrence of gain/loss events on all branches and splitting that list into training and test datasets either in a random (fivefold) or “hold-one-phylum-out” manner (Fig. 1E).
Both gene gains and losses are predictable at the macroevolutionary time scale For each metabolic pathway OG, each of gene gain and loss, and each of the two machine learning models, we drew average receiver operating characteristic (ROC) curves by simple fivefold cross-validation and calculated the areas under the curve (AUCs) (Fig. 2A and fig. S2A). Overall, the AUCs were substantially larger than 0.5 (i.e., random predictions), proving that both gene gains and losses are predictable using information from a parental gene content vector alone (Fig. 2B and fig. S2B). The AUCs of gene gains were significantly larger than those of gene losses (two-sided Mann-Whitney U test, P < 2.23 × 10−308 and P = 3.57 × 10−277 for RF and LR, respectively), indicating that gene gains are more predictable than gene losses. These results also suggest that gene gain is predictable even for OGs with relatively small gain events, but gene loss is not predictable for OGs with relatively small numbers of loss events. This may be because rare gene gain events are under stronger evolutionary constraints imposed by ancestral gene content, rather than rare gene loss events.
To verify the robustness of these results, we also applied a maximum parsimony method (21) and a neighbor-joining method (25) as alternative methods for ancestral gene content reconstruction and estimation of the reference phylogenetic tree, respectively. All combinations of these methods reproduced qualitatively similar results (fig. S3, A and B). The results were also reproduced when we conducted upsampling or downsampling of the training datasets to balance the number of positive and negative predictions (fig. S3C). When we included nonmetabolic pathway OGs in parental gene content vectors to predict metabolic pathway gene gains and losses, our methods obtained an almost similar performance (fig. S3D). This also indicates that the presence or absence of metabolic pathway OGs is sufficient for predicting gene gain/loss evolution in metabolic pathways.
Next, we considered collinearity among input features for the machine learning models because OGs with related functions are known to show similar phylogenetic distributions (26), and redundant features may worsen prediction performance. We conducted hierarchical clustering of OGs based on the similarity of presence/absence profiles in the extant species using the complete linkage method (27) and conducted the same analyses with dimension-reduced input vectors whose component was the number of present OGs in each OG cluster at each ancestral species. A moderate decrease in evolution-predictable OGs was observed when <20 OG clusters were used for prediction (fig. S4). The numbers of evolution-predictable OGs by the RF model with 30 OG clusters were 83.9 and 95.2% of those predicted by the original methods, respectively, indicating that ~30 dimensions provide almost sufficient information to predict gene content evolution of metabolic pathways. It is notable that model overfitting likely occurred, especially in the gene loss prediction by the LR model, where the number of evolution-predictable OGs became smaller when the input dimensions became larger than 20. Unexpectedly, gene gains of 55 OGs were predictable by the LR model using a one-dimensional input vector (i.e., by the total metabolic pathway gene numbers only), and 33 OGs among them showed the largest AUCs when the input vector was one-dimensional. These OGs were shown to be gained more frequently if the parental species had more metabolic pathway genes (fig. S5).
The AUCs of both gene gains and losses differed among metabolic functions (two-sided F test, P = 6.98 × 10−21 and P = 4.52 × 10−56, respectively, using the RF model; Fig. 2C and fig. S2C). For example, xenobiotics degradation and nucleotide metabolism showed the largest and smallest median AUCs for gene gains (0.723 and 0.693, respectively). Notably, these functions showed the smallest and second largest median AUCs for gene losses (0.515 and 0.662, respectively), but no negative correlation was generally observed between the AUCs of gene gains and losses (fig. S6).
Overall, the fact that gene gain/loss events are predictable for diverse metabolic pathway OGs strongly suggests that their evolutionary pressures and constraints are shared across different bacterial taxa. To carefully test whether those pressures or constraints were shared across phyla, we next conducted a hold-one-phylum-out validation as described, where test datasets were from phylogenetic branches in one phylum and training datasets were from the others. The results for the 10 most abundant phyla showed significant predictability (Fig. 2D and fig. S2D), where the predictability significantly differed among different phyla (two-sided F test, P = 2.01 × 10−99 and P = 3.54 × 10−35 for gene gains and losses, respectively, using the RF model). For example, Proteobacteria showed poor predictability for gene loss, suggesting that gene loss evolution of proteobacterial metabolic systems has unique patterns and/or occurs stochastically.
The presence of functionally related genes is important for gene gain/loss prediction Next, we quantified the contribution of each feature to the prediction of gene gain or loss events for each OG. We carried out gene gain/loss predictions using input vectors whose elements were the estimated number of metabolic reactions in each functional module defined by the KEGG Module [e.g., gluconeogenesis (ID: M00003) and pentose phosphate pathway (ID: M00004)] in each ancestral species (Fig. 3A). We also examined other feature sets based on KEGG PATHWAY and Enzyme Commission numbers but found that the KEGG Module performed best when using the RF model (fig. S7). We evaluated the importance of the features using two methods: F value of analysis of variance (ANOVA) and RF model importance score. We also calculated the average AUCs by fivefold cross-validation using only the top N important features (N = 1, 2, ..., 50) to determine the optimal number of selected features.
The RF model obtained the best performance, regardless of the selection of the feature importance scores (Fig. 3B), probably because the RF model is more robust to overfitting (28). The largest median value of average cross-validated AUCs was achieved by the RF model and ANOVA when the number of selected features was 14 and 8 for gene gains and losses, respectively. The optimal numbers of selected features were similar, regardless of the functions of the OGs (fig. S8A). The optimal feature numbers for predicting gene gains were larger than those for predicting gene losses, regardless of the selection of the feature importance scores, suggesting that evolutionary constraints on gene gains depend on more functional modules than those on gene losses (fig. S8B).
Next, we investigated the characteristics of the critical features in predicting the gene gain/loss events of each OG by focusing on the effect of metabolic reactions that belong to the same functional module of the target OG. The importance rank of the same functional module was markedly skewed to one for both gene gains and losses (Fig. 3C), indicating that the number of metabolic reactions in the same functional module is an important factor in predicting gene gain/loss events of most OGs. More reactions in the same module increased gene gain probabilities but decreased gene loss probabilities. This result is reasonable because the presence and absence of functionally related genes are expected to promote gene gain and loss, respectively (18, 29). Similarly, other important features for predicting gene gain/loss events were enriched in modules belonging to the same category (Fig. 3D and fig. S9). Functional categories that showed substantial enrichment corresponded to categories whose gene gain/loss events were predictable with large AUCs (fig. S8A), suggesting that the prediction of gene gain/loss events is principally empowered by evolutionary constraints arising from functional linkages with other genes.
Model interpretation revealed biases in gene gain/loss orders in pathway evolution To further interpret the rules behind metabolic pathway evolution, we investigated the relationships between pairs of closely coupled functional modules that consist of one serial metabolic pathway. As a model system, we focused on gene gains in xenobiotics degradation and gene losses in the metabolism of nucleotides, cofactors, vitamins, and amino acids because these evolutionary events are more predictable than other functions in the RF model (Fig. 2C).
In xenobiotics degradation, the presence of genes for downstream metabolic reactions in the parental gene content was more important for predicting gene gains than for the upstream reactions (Fig. 4A). For 10 of the 15 tested functional module pairs, downstream functional modules significantly enhanced gene gains in the upstream functional modules, but that of the upstream modules did not enhance gene gains in the downstream functional modules (Fig. 4, B and C, and fig. S10). That is, there are trends of downstream-to-upstream gene gains in the evolution of these pathways, which are visualized by mapping the possession of upstream/downstream modules onto phylogeny (Fig. 4D). We also found that the possession of downstream functional modules decreased the predicted probability of losing genes in upstream modules (fig. S11A), for example, in the biosynthetic pathways of tryptophan and isoleucine (figs. S11, B to D, and S12). This result suggests that losing the downstream modules of these pathways increases the loss probability of genes for the upstream modules and that gene losses occur in a downstream-to-upstream direction.
We anticipate that the downstream-to-upstream trends in pathway evolution would be because (i) the need for substrates of downstream metabolic reactions invokes evolutionary pressure to gain genes in the upstream reactions [consistent with a previously proposed model (30)]; and (ii) once such upstream reactions are obtained, their products will be used for other reactions, and upstream reactions become more difficult to lose than downstream reactions (e.g., shared upstream reactions in phenylalanine, tyrosine, and tryptophan syntheses). In either case, functional dependencies among metabolic reactions can constrain the order of gene gain and loss.
Meta-analysis of metagenomes reveals the ecological basis behind pathway evolution In addition to the general downstream-to-upstream trends in metabolic pathway evolution, we hypothesized that other evolutionary pressures or constraints shared by different phylogenetic clades also cause repetitive and predictable evolution. To test this hypothesis, we first conducted a meta-analysis of published metagenomic datasets from various environments to create a comprehensive list of habitat environments for every extant bacterial species using a previously developed method (21). Specifically, the relative abundance of each bacterial species in each environment was quantitatively evaluated as a habitat preference score using massive Basic Local Alignment Search Tool (BLAST) searches of 16S ribosomal RNA (rRNA) sequences. Then, we evaluated correlations between habitat preference scores and the number of reactions in xenobiotics degradation for extant bacterial species. The five most well-correlated environments were “rhizosphere,” “soil,” “sludge,” “biosolids,” and “plant” (Fig. 5, A and B), which were consistent with the previous case studies that reported xenobiotics degradation in those environments (31, 32). Plants are known to emit aromatic compounds (33–35), which have been previously suggested to form selective pressures for microbes to degrade xenobiotics (32).
Next, we estimated the habitat environments of ancestral species using a similar ancestral reconstruction method (see Methods). We tested whether ancestral species inhabiting those environments more frequently acquired metabolic reactions in xenobiotics degradation, which is whether the shared gene gain patterns were based on shared environmental conditions. The upstream and downstream functional modules of several xenobiotics degradation pathways (especially catechol-mediated pathways) were significantly more frequently gained in soil. In contrast, only the upstream functional modules were markedly increased in the other four environments (Fig. 5C). We further revealed that species inhabiting the soil frequently spread into the rhizosphere and plant environments at the macroevolutionary time scale (Fig. 5D). Thus, it is likely that many bacterial clades gained downstream modules in the soil, then spread to the rhizosphere or plant body, and gained upstream genes (Fig. 5E). Consistently, we also noted that species inhabiting soil, but not the rhizosphere or plant, frequently have downstream modules only (Fig. 5F).
Pan-genomic analysis proves that our framework can predict ongoing evolution Last, we examined whether Evodictor can predict the ongoing and future evolution of metabolic systems. Given a gene content vector of extant species, our machine learning model can also predict the probabilities of gene gain/loss in the future. Although we cannot know the genomes of future bacterial species without time machines, we can see variations within multiple genomes from the same extant species, that is, pan-genomes. Gene content varies among different strains of a bacterial species, typically because of frequent HGTs and gene losses (36–39). Our rationale is that if genes predicted to be gained are already partially present in the pan-genomes of a species, then our machine learning model can predict future evolution (Fig. 6A). In addition, note that, in population genetics, evolution is defined by changes in genetic compositions in populations.
We selected species for which 15 or more complete genomes were available from the RefSeq database, narrowing the list to 114 species from various lineages (fig. S13). We excluded genomes that showed >99% gene content similarity with other genomes in the same species to reduce redundancies. For every combination of OG and species, we calculated the ratios of genomes that had genes belonging to the OG. These ratios were distributed between zero and one, representing intraspecies genomic variations (Fig. 6B and fig. S14). For 3.69% of all OG-species combinations, the possession ratios were greater than zero, despite the species being annotated as lacking OG in the KEGG database. We defined such an OG-species pair as ongoing gene gain evolution. Likewise, ongoing gene loss evolution was defined as an OG-species pair whose possession ratio was less than 0.9 with gene presence annotation in KEGG.
Our model successfully predicted the ongoing gene gain and loss evolution with median AUCs of 0.82 and 0.71, respectively (Fig. 6C). These successful predictions were not limited to specific phylogenetic clades, which mean that our machine learning models reflect universal evolutionary pressures and constraints shared across different lineages (Fig. 6D). Changing the thresholds of the possession ratios for defining ongoing evolution did not affect the results, except for when the threshold for ongoing gene loss was set to over 0.95, likely because near-complete genomes were incorrectly regarded as gene loss cases (fig. S15). Last, we validated our predictions of ongoing gene loss evolution using experimentally identified essential gene datasets of 29 species (40, 41) under the assumption that ongoing gene loss evolution avoids essential genes. The ongoing gene loss probabilities showed AUCs significantly larger than 0.5 (two-sided one-sample t test, P = 2.42 × 10−11) (Fig. 6E).
DISCUSSION This study developed a computational framework, Evodictor, for learning the general patterns behind gene gain/loss events at the macroevolutionary scale and enabling gene-by-gene prediction of future gene gain/loss events based on the genomes of extant species. Cross-validation and pan-genome analysis showed that gene gain/loss events are universally predictable for various metabolic OGs using our framework. Our framework enables the prediction of gene gains and losses, discussed separately in previous studies (18, 19). Because of this characteristic, gene losses were revealed to be less predictable than gene gains (Figs. 2A, 3B, and 6C and figs. S2A, S3, B to D, and S4), consistent with previous reports on gene losses under relaxed evolutionary pressures associated with environmental changes (42).
Further investigation of metabolic pathway architectures and meta-analysis of metagenomic datasets demonstrated that our method detects evolutionary patterns whose universality has solid physiological and ecological bases. From a physiological aspect, the downstream-to-upstream evolutionary order in metabolic pathway evolution is consistent with the retrograde model originally proposed to explain pathway evolution by gene duplication, where the fitness effect of gene gain is determined by functional dependencies (43). From an ecological aspect, habitat transition patterns from soil to plant-associated environments were found to correlate with gene gain orders. This also suggests that Evodictor performance may be improved by inferring past environments based on abundant metagenomic datasets and explicitly using that information for the evolutionary prediction.
There are several rooms to improve and extend the Evodictor framework. It is envisioned to train predictive models by considering uncertainties in reconstructing phylogenetic trees and ancestral gene content. Consideration of time (e.g., branch length) information would also be promising, although dating prokaryotic phylogenetic trees is intrinsically difficult because of few fossil records (44). Furthermore, while the present method uses a gene content vector only of the parental node for prediction (i.e., Markov property assumption), those of grand parental nodes would provide information about how the environment is changing at the parent node and what genes will be likely gained/lost next. In addition, instead of the presence/absence data of OGs, we may embed protein sequence data into a vector by protein language models to consider inter-/intraortholog sequence diversities (45–47). Last, the iterative application of Evodictor may let us simulate long-term genome evolution and conduct orbit analysis in a genomic state space. Whether the dynamics of bacterial genome evolution will be caught in some attractors and oscillate, converge to equilibrium, or continue to diverge would be of special interest in biophysics of genome evolution.
Evodictor is a versatile analysis framework that requires only a lineage tree (e.g., phylogenetic tree) and a trait table (e.g., ortholog table) as inputs. Thus, in addition to metabolic system evolution, it is envisioned that Evodictor will predict pathogenic species that will likely gain antibiotic resistance genes via HGTs to mitigate the potential risks of resistance disseminations (3, 48, 49). Predicting the gain/loss potential of various genes would be beneficial for estimating the feasibility of knockin/knockout experiments and stability of edited genomes in bioengineering and synthetic biology (6, 50). Furthermore, Evodictor may also be useful in estimating the future influence of synthetic genomes in the context of ethical, legal, and social issues. In addition to genome evolution, Evodictor can be applied to evolution of transcriptomes by organs (51) and of phenotypic traits such as butterfly wing patterns (52) and morphology of plants and Aves (53, 54). From a broader perspective, single-cell transcriptomics will also be empowered if a cell lineage tree and a cell-gene matrix of expression levels (as a trait table) are given to Evodictor to decipher the universal rules behind cell differentiation by taking advantage of the rapidly progressing cell lineage tracing technologies (55, 56). Evodictor, as a framework for modeling and predicting diversification of complex biological systems, would become more beneficial as we obtain larger lineage trees and trait databases, which are growing with various omics technologies.
METHODS Datasets Species tree and gene content of bacterial species The phylogenetic reference tree of bacterial species and multiple sequence alignment were downloaded from the Genome Taxonomy Database (GTDB; release 89) (20) on 16 February 2021. The gene content of each bacterial species was downloaded from the KEGG (24) database on 1 April 2020. Here, the gene content is represented as a list of KEGG Orthology (KO) identifiers. Throughout this study, we mainly used gene content data for metabolic OGs, defined as KOs to which at least one entry in the KEGG REACTION database was linked. We listed 2894 species registered in both GTDB and KEGG and then randomly selected one representative genome for each selected species from GTDB and KEGG, respectively. The phylogenetic tree of the selected genomes was extracted from the GTDB reference phylogeny using the TreeNode.prune function in ete3 toolkit 3.1.1 (57) by preserving the branch lengths (with an option “preserve_branch_length = True”).
Nucleotide sequence of 16S rRNA gene For the 2894 selected genomes in GTDB, we downloaded the nucleotide sequences of noncoding RNA genes (files named “*_rna_from_genomic.fna.gz”) if they were available at GenBank or RefSeq. We extracted the longest sequence of 16S rRNA genes in each genome and collected representative sequences of 16S rRNA genes for 2835 species.
Nonrepresentative genomes For each species used in the analyses of metabolic system evolution, we downloaded amino acid sequences of all complete genomes (files named as “*_protein.faa.gz,” where the asterisk represents an arbitrary string) from RefSeq if 15 or more complete genomes were available for that species. We downloaded 10,937 genomes of 148 species on 28 October 2020.
Gene essentiality Essentiality information for every gene in 29 bacterial species was downloaded from ePath (41) on 30 May 2021. Gene essentiality was based on experimental data from previous studies in which viability was measured after the knockdown/knockout of every single gene. Every gene in the database was assigned a KO identifier.
Alternative phylogenetic tree reconstruction We reconstructed an alternative phylogenetic tree of bacterial species from the multiple sequence alignment in GTDB (see the “Datasets” section) using RapidNJ 2.3.2 (25) with “-b -t p -n”. After tree reconstruction, the lineage of species registered in the GTDB and KEGG was extracted, as described above. The resulting tree was rooted in the common ancestor of the species in the smaller-child clade of the root node of the reference phylogenetic tree.
Estimation of ancestral gene content The gene content of ancestral species corresponding to every internal node in the reference phylogeny was estimated by ancestral state reconstruction of the presence/absence of every OG using PastML 1.9.15 (21). We used two different reconstruction methods: an empirical Bayesian method [the marginal posterior probability approximation (MPPA) method with the F81-like model] and a maximum parsimony method (the DOWNPASS method). Both methods inferred the presence or absence of an OG at every ancestral node, and some ancestral states were undetermined because of uncertainty.
Prediction of gene gains/losses by Evodictor Predictive model We used two different predictive models, LR and RF, implemented in Scikit-learn 0.24.2 (58) that was used to evaluate the predictability of gene gain and loss. The input of prediction was a feature vector x (see the “Input features” section), representing the gene content at the parental node of a target branch. The output was the probabilities of gene gains/losses y (∈ [0,1]) at that branch. We used L2-regularization for parameter fitting of the LR model, and we set the number of estimators and the maximum tree depth of the RF model to 100 and 2 throughout this study, respectively.
Input features We used multiple methods for the feature vector representation of metabolic gene content. Initially, we vectorized gene content by representing the presence or absence of each OG in a species as one and zero of a vector element (in the analyses for Fig. 2 and figs. S2, S3, and S6). That is, the gene content contained OG i if xi = 1, and not if xi = 0 (xi ∈ {0,0.5,1}). Here, the number of dimensions of the feature vector x was 3585, which is the total number of metabolic OGs, except for fig. S3D, where the presence/absence of nonmetabolic OGs was also included in the feature vector (10,130 dimensions in total). When the ancestral state of the presence/absence of OG i was undetermined, we set xi to 0.5.
Next, we used a compressed feature vector as a predictor to consider collinearity among features (in the analyses for figs. S4 and S5). We conducted hierarchical clustering of OGs based on the similarity of presence/absence profiles in the 2894 extant species using the complete linkage method implemented in Scikit-learn 0.24.2, using the Hamming distance as a metric. Then, the OGs were partitioned into a defined number (C) of clusters. We represented the gene content x as a C-dimensional vector, whose element xi was the number of possessed OGs included in cluster i (i ∈ 1,2, …, C). When the presence or absence of an OG included in cluster i was undetermined for an ancestor, 0.5 was added to xi for the OG.
Last, we used feature vectors explicitly reflecting the functions and/or mechanisms of metabolic reactions to help interpret evolution patterns (in the analyses for Fig. 3 and figs. S7 to S11). We first obtained a set of metabolic reactions for each extant/ancestral species by mapping each KO identifier to a KEGG REACTION identifier. In the mapping procedure, each species was defined as having a metabolic reaction if it had at least one OG linked to that reaction. Then, we defined the input features as the number of metabolic reactions belonging to every group of functionally related or mechanistically similar reactions. Meaning, xi represents the number of possessed OGs included in the reaction group i. We used three different sets of reaction groups to construct the feature vectors:
1) Functionally related reaction groups were registered as pathway modules in KEGG Module database (referred as “functional modules” in the main text Results section).
2) Functionally related reaction groups were registered in the KEGG PATHWAY database (written as “pathway” in the main text Results section).
3) Groups of mechanistically similar reactions share the first digit or first and second digits of the Enzyme Commission number.
We constructed feature vectors for each one or union of the three reaction group sets shown above. Predictability assessment by cross-validation
We evaluated gene gain/loss predictability for each OG using cross-validation. When we predicted gene gains/losses, we defined target branches as branches whose parental species did not or did have the OG, respectively. Note that we excluded a branch in the target branches if the presence or absence of the predicted OG in the child species of the branch was undetermined. For each prediction target branch, we first enumerated (x, ytrue) for each prediction target branch, where x is the feature vector of the parental ancestor of the branch and ytrue (∈ {0,1}) is the occurrence of gene gain/loss at the branch (ytrue = 1 if gain/loss occurred at the branch; ytrue = 0 otherwise). Then, we separated the enumerated sets of (x, ytrue) into training and test datasets using fivefold stratified cross-validation. Last, we drew average ROC curves and calculated the average AUC to evaluate the predictability. This study assessed the gain/loss predictability of OGs gained/lost five times or more to make the fivefold cross-validation feasible (and assessed the predictability of 2412 OGs and 2672 OGs in total metabolic 3585 OGs, respectively, when we used the MPPA method as the ancestral state reconstruction and GTDB reference tree). To statistically test gene gain/loss predictability for every OG, we calculated the P values of each AUC using the null distribution obtained by randomly shuffling the correspondence between species and predicted probabilities 100,000 times. In the fivefold cross-validation analyses, the median P value was used to represent the P values of the five AUCs.
Predictability assessment by hold-one-phylum-out validation We assessed the predictability of gene gain/loss in one phylum after training predictive models with the evolution of other phyla to verify the existence of evolutionary patterns shared across different phyla. We first enumerated (x, ytrue) for the prediction of target branches as described above. Then, the set of (x, ytrue) for branches in one phylum and that for branches in other phyla were treated as a test dataset and training dataset, respectively. Here, the branches upstream of all phyla were not included in the prediction target branches. Last, the models were trained using the training dataset, and the prediction and calculation of the AUC were conducted using the test dataset. We assessed the gain/loss predictability of OGs gained/lost once or more in the predicted phylum and other phyla.
Feature selection We used only the selected input features to predict future gene gains/losses to preventing overfitting. For the gain/loss prediction of each OG, we first calculated two different feature importance scores (F value of ANOVA and feature importance in the RF model) for each candidate feature. The candidate feature was the number of reactions possessed in each functional module. Feature importance scores were calculated from feature values normalized by the sklearn.preprocessing.StandardScaler function. We then selected features that showed the top S values of the feature importance score (S = 1, 2, …, 50). Last, we evaluated the predictability of gene gain/loss using the selected S features by calculating the cross-validated AUC to determine the optimal number of features for prediction.
Habitat estimation for extant and ancestral species For each species with an annotated sequence of the 16S rRNA gene, we estimated its habitats by BLAST searching the 16S rRNA sequence in metagenome datasets of various environments using ProkAtlas online (59) on 1 September 2020. We set the ProkAtlas parameters of the nucleotide identity and sequence coverage thresholds to 97% and 150 base pairs, respectively. A species was considered present in an environment if its habitat preference score, calculated using ProkAtlas, was greater than zero. We then reconstructed the existence of each ancestral species in each environment using PastML (MPPA method with an F81-like model). Note that we could not calculate the habitat preference score of extant species whose 16S rRNA sequence was not retrievable, so those values were given as a blank when we ran PastML.
Detecting habitat change patterns at a macroevolutionary time scale To detect patterns of habitat changes during the macroevolution of diverse bacteria, we statistically tested whether species inhabiting the environment e1 more frequently spread to another environment e2 than species not inhabiting e1. Here, we tested habitat changes from soil to four other environments (rhizosphere, sludge, biosolids, and plants) and from these environments to soil. By analyzing the reconstructed habitat change history on the reference phylogeny (see the “Habitat estimation for extant and ancestral species” section), we created a 2 by 2 contingency table for the two-sided Fisher’s exact test. We classified branches in the reference phylogeny based on whether the ancestral state of the environment e1 at the parental node of the branch was one or zero and whether the ancestral state of environment e2 changed from zero to one on the branch. Note that we only classified branches whose parental node’s state in environment e2 was zero.
Detecting acquisition of metabolic reactions affected by habitat environment To detect the influence of habitat on gene gain frequency, we statistically tested whether species inhabiting an environment acquired more metabolic reactions for a functional module than species not inhabiting the environment. This study tested the effects of five environments (soil, rhizosphere, sludge, biosolids, and plants) on the gene gain of all functional modules for xenobiotics degradation. By analyzing the reconstructed history of habitat change and gene content change on the reference phylogeny (see the “Habitat estimation for extant and ancestral species” section), we created a 2 by 2 contingency table for a two-sided Fisher’s exact test. We classified all branches in the reference phylogeny based on whether the ancestral state of the environment at the parental node of the branch was one or zero and whether any metabolic reaction for the functional module was acquired on the branch.
Measuring predictability of ongoing gene gain/loss in microevolutionary time scale Future gene gain/loss prediction
To predict future gene gain/loss evolution, we predicted the probabilities of gene gain/loss from the gene content of extant species retrieved from KEGG. We used it as the predictive model. The input features of the prediction were selected features whose numbers were optimized for each OG described in the “Feature selection” section.
Analyses of intraspecies gene content variation To evaluate the validity of the prediction, we next analyzed the intraspecies gene content variation of each extant species and verified whether the species predicted to have a high probability of acquiring or losing a certain OG tended to include strains that had gained/lost the OG. We first downloaded the amino acid sequences of the protein-coding genes of all complete genomes of 148 species (see the “Datasets” section). We then assigned a KO identifier for each gene in each downloaded genome using KOfamScan 1.3.0 (60). Next, redundant genomes that showed >99% gene content overlap (Jaccard index) with one or more genomes of the same species were excluded. In the downstream analyses, we used only 114 species, for which 15 or more genomes were still available after removing redundancy.
Next, for every combination of OG and species, we calculated the possession ratio, defined as the fraction of genomes possessing OG in all the analyzed genomes of the species. We defined a species as under “ongoing gene gain” of an OG if the species and its parental species were annotated or inferred as not possessing the OG while the possession ratio was over a threshold. Similarly, species were defined as under ongoing gene loss of an OG if the species and its parental species were annotated or inferred as possessing the OG, whereas the possession ratio was under a threshold. The threshold varied from zero to 0.10 for ongoing gain and 0.89 to 0.99 for ongoing loss to examine the robustness of the result. To quantify the validity of the prediction, we tested whether the predicted gene gain/loss probability correlated with the ongoing gain/loss label by calculating the AUC. To discriminate a species under ongoing gain from one under ongoing loss and vice versa, we predicted the gain and loss of an OG for extant species only when the species itself and its latest ancestor in the reference tree did not and did have the OG based on the KEGG database and the results of ancestral state reconstruction, respectively.
Predictability assessment of gene essentiality To verify whether our model could predict the gene loss potentials of extant species, we assessed the predictability of gene essentiality differences among species. We measured the AUC for each OG using the gene loss probability predicted for a species as a score indicating how likely the OG is to be inessential for the species. We analyzed predictability only for 454 OGs, which are essential and inessential for two or more of the 29 species registered in the ePath database (see the “Datasets” section). Then, we tested whether the distribution of AUCs was larger or smaller than 0.5, using a two-sided one-sample t test.
Data visualization and statistical tests We visualized phylogenetic trees and the associated data (labels of phyla, distributions of genes/functional modules, and predicted gain/loss probabilities) using iTOL v6 (61). We generated the other plots using Matplotlib 3.4.2 and Seaborn 0.11.0 (62). We conducted statistical tests (Wilcoxon signed-rank test, Spearman’s correlation test, two-sided t test, and Fisher’s exact test) using Scipy 1.6.2 (63). We used Statsmodels 0.12.2 (64) for multiple test corrections by calculating false discovery rates (FDRs) (65).